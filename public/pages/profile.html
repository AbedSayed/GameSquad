<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | GameSquad</title>
    
    <!-- Unified Theme System -->
    <link rel="stylesheet" href="../css/gamesquad-theme.css">
    <link rel="stylesheet" href="../css/animations.css">
    <link rel="stylesheet" href="../css/gaming-styles.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/profile.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/profile.js"></script>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1 class="sheen">GameSquad</h1>
            </div>
            <ul class="nav-links">
                <li><a href="../home.html">Home</a></li>
                <li><a href="lobbies.html">Lobbies</a></li>
                <li><a href="players.html">Players</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="user-profile">
                <span class="username">Username <i class="fas fa-chevron-down"></i></span>
                <div class="profile-dropdown">
                    <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                    <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
                    <a href="#" class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="page-title">
            <h1 class="neon-text">MY PROFILE</h1>
        </div>

        <div class="profile-container fade-element">
            <div class="profile-content fade-stagger">
                <!-- Profile Card Section -->
                <div class="profile-card glow-effect">
                    <div class="profile-image-container">
                        <div class="avatar-wrapper">
                            <img id="profile-avatar" src="../resources/default-avatar.png" alt="Profile Avatar" class="profile-avatar">
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-display-name">Loading...</h2>
                        <p id="profile-username" class="profile-username">@username</p>
                        <p id="profile-bio" class="profile-bio">Loading bio...</p>
                        <div class="profile-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="profile-joined">Joined: Loading...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-gamepad"></i>
                                <span id="profile-games-played">Games: 0</span>
                            </div>
                        </div>
                        <button id="edit-profile-btn" class="btn-primary glow-on-hover">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Game Ranks Section -->
                <div class="profile-section game-ranks-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-medal"></i> GAME RANKS</h3>
                    <div id="game-ranks-container" class="game-ranks-grid">
                        <!-- Game ranks will be added here dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-gamepad"></i>
                            <p>No game ranks added yet</p>
                        </div>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="profile-section preferences-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-sliders-h"></i> PREFERENCES</h3>
                    <div class="preferences-grid">
                        <div class="preference-item">
                            <h4>Play Style</h4>
                            <p id="pref-play-style">Casual</p>
                        </div>
                        <div class="preference-item">
                            <h4>Communication</h4>
                            <p id="pref-communication">Both</p>
                        </div>
                        <div class="preference-item">
                            <h4>Play Time</h4>
                            <p id="pref-play-time">Evening</p>
                        </div>
                        <div class="preference-item">
                            <h4>Region</h4>
                            <p id="pref-region">North America</p>
                        </div>
                    </div>
                </div>

                <!-- Languages & Interests Section -->
                <div class="profile-section dual-section glow-effect">
                    <div class="languages-section">
                        <h3 class="section-title"><i class="fas fa-language"></i> LANGUAGES</h3>
                        <div id="languages-container" class="tags-container">
                            <!-- Languages will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i>
                                <p>No languages added</p>
                            </div>
                        </div>
                    </div>
                    <div class="interests-section">
                        <h3 class="section-title"><i class="fas fa-heart"></i> INTERESTS</h3>
                        <div id="interests-container" class="tags-container">
                            <!-- Interests will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-heart-broken"></i>
                                <p>No interests added</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2 class="neon-text">GameSquad</h2>
                    <p>Find your perfect gaming team</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Navigation</h3>
                        <ul>
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="lobbies.html">Lobbies</a></li>
                            <li><a href="players.html">Players</a></li>
                            <li><a href="profile.html">Profile</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Legal</h3>
                        <ul>
                            <li><a href="terms.html">Terms of Service</a></li>
                            <li><a href="privacy.html">Privacy Policy</a></li>
                            <li><a href="cookies.html">Cookie Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="faq.html">FAQ</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                            <li><a href="report-bug.html">Report a Bug</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer-social">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="#" class="power-button"><i class="fab fa-discord"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 GameSquad. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Notifications Container -->
    <div class="notifications-container"></div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-display-name">Display Name</label>
                        <input type="text" id="edit-display-name" name="displayName" placeholder="Your display name">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-bio">Bio</label>
                        <textarea id="edit-bio" name="bio" placeholder="Tell us about yourself"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-avatar">Avatar URL</label>
                        <input type="text" id="edit-avatar" name="avatar" placeholder="URL to your avatar image">
                    </div>
                    
                    <h3>Preferences</h3>
                    
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="edit-play-style">Play Style</label>
                            <select id="edit-play-style" name="playStyle">
                                <option value="Casual">Casual</option>
                                <option value="Competitive">Competitive</option>
                                <option value="Mix">Mix</option>
                            </select>
                        </div>
                        
                        <div class="form-group half">
                            <label for="edit-communication">Communication</label>
                            <select id="edit-communication" name="communication">
                                <option value="Voice">Voice</option>
                                <option value="Text">Text</option>
                                <option value="Both">Both</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="edit-play-time">Play Time</label>
                            <select id="edit-play-time" name="playTime">
                                <option value="Morning">Morning</option>
                                <option value="Afternoon">Afternoon</option>
                                <option value="Evening">Evening</option>
                                <option value="Night">Night</option>
                                <option value="Weekends">Weekends</option>
                                <option value="Flexible">Flexible</option>
                            </select>
                        </div>
                        
                        <div class="form-group half">
                            <label for="edit-region">Region</label>
                            <select id="edit-region" name="region">
                                <option value="North America">North America</option>
                                <option value="Europe">Europe</option>
                                <option value="Asia">Asia</option>
                                <option value="South America">South America</option>
                                <option value="Oceania">Oceania</option>
                                <option value="Africa">Africa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-languages">Languages (comma separated)</label>
                        <input type="text" id="edit-languages" name="languages" placeholder="English, Spanish, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-interests">Interests (comma separated)</label>
                        <input type="text" id="edit-interests" name="interests" placeholder="RPGs, FPS, Strategy, etc.">
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main JS -->
    <script src="../js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize animation elements
            const fadeElements = document.querySelectorAll('.fade-element');
            fadeElements.forEach(element => {
                element.classList.add('appear');
            });

            setTimeout(() => {
                const staggerElements = document.querySelectorAll('.fade-stagger');
                staggerElements.forEach(element => {
                    element.classList.add('appear');
                });
            }, 300);

            // Load user profile data
            loadUserProfile();
            
            // Set up tabs if the function exists
            if (typeof window.Profile !== 'undefined' && typeof window.Profile.setupTabs === 'function') {
                window.Profile.setupTabs();
            } else {
                console.log('setupTabs function not available');
            }
        });

        // Load user profile data from database
        async function loadUserProfile() {
            try {
                // Check if user is logged in - fix the function reference issue
                // Try multiple possible locations of the function
                let isUserLoggedIn = false;
                
                if (typeof window.Auth !== 'undefined') {
                    if (typeof window.Auth.isLoggedIn === 'function') {
                        isUserLoggedIn = window.Auth.isLoggedIn();
                    } else if (typeof window.isLoggedIn === 'function') {
                        isUserLoggedIn = window.isLoggedIn();
                    } else if (typeof window.AUTH !== 'undefined' && typeof window.AUTH.isLoggedIn === 'function') {
                        isUserLoggedIn = window.AUTH.isLoggedIn();
                    } else {
                        // Fallback method - check if token exists
                        isUserLoggedIn = !!localStorage.getItem('token');
                    }
                } else {
                    // Fallback to checking token directly
                    isUserLoggedIn = !!localStorage.getItem('token');
                }
                
                if (!isUserLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Show loading state
                showLoadingState();
                
                let profileData;
                
                // Use getAllProfiles function to get all profiles from the database
                if (typeof window.Profile !== 'undefined' && typeof window.Profile.getAllProfiles === 'function') {
                    try {
                        console.log('Getting all profiles from Profile.getAllProfiles API');
                        const allProfiles = await window.Profile.getAllProfiles();
                        console.log('All profiles retrieved from API:', allProfiles);
                        
                        // Get the current user's ID
                        const userInfoStr = localStorage.getItem('userInfo');
                        if (!userInfoStr) {
                            throw new Error('No user info found. Please log in again.');
                        }
                        
                        const userInfo = JSON.parse(userInfoStr);
                        const currentUserId = userInfo._id || userInfo.id || userInfo.userId;
                        
                        // Find the current user's profile from all profiles
                        profileData = allProfiles.find(profile => 
                            profile._id === currentUserId || 
                            (profile.user && profile.user._id === currentUserId)
                        );
                        
                        if (!profileData && allProfiles.length > 0) {
                            // If we couldn't find the exact profile, use the first one (for demo purposes)
                            console.warn('Could not find exact profile match, using first profile');
                            profileData = allProfiles[0];
                            showNotification('Demo mode: Showing sample profile data', 'info');
                        }
                        
                        console.log('Current user profile found:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Profile.getAllProfiles:', apiError);
                        throw new Error('Failed to fetch profiles from API: ' + apiError.message);
                    }
                } 
                // Try to get profile using Auth.getUserProfile (fallback)
                else if (typeof window.Auth !== 'undefined' && typeof window.Auth.getUserProfile === 'function') {
                    try {
                        console.log('Getting profile from Auth.getUserProfile API');
                        profileData = await window.Auth.getUserProfile();
                        console.log('Profile retrieved from API:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Auth.getUserProfile:', apiError);
                        throw new Error('Failed to fetch profile from API: ' + apiError.message);
                    }
                } 
                // Fallback to Profile.getMyProfile if Auth.getUserProfile is not available
                else if (typeof window.Profile !== 'undefined' && typeof window.Profile.getMyProfile === 'function') {
                    try {
                        console.log('Getting profile from Profile.getMyProfile API');
                        profileData = await window.Profile.getMyProfile();
                        console.log('Profile retrieved from API:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Profile.getMyProfile:', apiError);
                        throw new Error('Failed to fetch profile from API: ' + apiError.message);
                    }
                } 
                // If no APIs are available, get minimal data from localStorage
                else {
                    console.warn('No profile API functions available');
                    // Get minimal data from localStorage
                    const userInfoStr = localStorage.getItem('userInfo');
                    if (!userInfoStr) {
                        throw new Error('No user profile found. Please log in again.');
                    }
                    
                    const userInfo = JSON.parse(userInfoStr);
                    profileData = userInfo.profile || {
                        user: {
                            _id: userInfo._id,
                            username: userInfo.username,
                            email: userInfo.email
                        },
                        displayName: userInfo.username
                    };
                    
                    console.log('Using minimal profile data from localStorage');
                    showNotification('Limited profile data available. Some features may not work properly.', 'info');
                }
                
                console.log('Profile data loaded:', profileData);
                
                // Update UI with profile data
                updateProfileUI(profileData);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile: ' + error.message, 'error');
            }
        }
        
        // Show loading state in UI
        function showLoadingState() {
            // Set loading indicators for each section
            document.getElementById('profile-display-name').textContent = 'Loading...';
            document.getElementById('profile-username').textContent = '@loading';
            document.getElementById('profile-bio').textContent = 'Loading bio...';
        }
        
        // Update UI with profile data
        function updateProfileUI(profile) {
            // Basic user info
            const displayName = profile.displayName || (profile.user ? profile.user.username : 'User');
            const username = profile.user ? profile.user.username : '';
            
            document.getElementById('profile-display-name').textContent = displayName;
            document.getElementById('profile-username').textContent = username ? `@${username}` : '';
            
            // Profile image
            const avatarEl = document.getElementById('profile-avatar');
            if (avatarEl) {
                const avatarUrl = profile.avatar || '../resources/default-avatar.png';
                if (avatarUrl && !avatarUrl.startsWith('http')) {
                    avatarEl.src = `../${avatarUrl.startsWith('/') ? avatarUrl.substring(1) : avatarUrl}`;
                } else {
                    avatarEl.src = avatarUrl || '../resources/default-avatar.png';
                }
            }
            
            // Bio
            const bioEl = document.getElementById('profile-bio');
            if (bioEl) {
                bioEl.textContent = profile.bio || 'No bio provided';
            }
            
            // Join date
            const joinedEl = document.getElementById('profile-joined');
            if (joinedEl && profile.createdAt) {
                const date = new Date(profile.createdAt);
                joinedEl.textContent = `Joined: ${date.toLocaleDateString()}`;
            }
            
            // Games played count for the profile card
            if (profile.gamesPlayed !== undefined) {
                const gamesPlayedEl = document.getElementById('profile-games-played');
                if (gamesPlayedEl) {
                    gamesPlayedEl.textContent = `Games: ${profile.gamesPlayed}`;
                }
            }
            
            // Game ranks
            const gameRanksContainer = document.getElementById('game-ranks-container');
            if (gameRanksContainer && profile.gameRanks && profile.gameRanks.length > 0) {
                gameRanksContainer.innerHTML = '';
                
                profile.gameRanks.forEach(gameRank => {
                    const gameRankCard = document.createElement('div');
                    gameRankCard.className = 'game-rank-card';
                    gameRankCard.innerHTML = `
                        <h4>${gameRank.game}</h4>
                        <div class="rank-badge">${gameRank.rank}</div>
                    `;
                    gameRanksContainer.appendChild(gameRankCard);
                });
            }
            
            // Preferences
            if (profile.preferences) {
                if (profile.preferences.playStyle) {
                    document.getElementById('pref-play-style').textContent = profile.preferences.playStyle;
                }
                
                if (profile.preferences.communication) {
                    document.getElementById('pref-communication').textContent = profile.preferences.communication;
                }
                
                if (profile.preferences.playTime) {
                    document.getElementById('pref-play-time').textContent = profile.preferences.playTime;
                }
                
                if (profile.preferences.region) {
                    document.getElementById('pref-region').textContent = profile.preferences.region;
                }
            }
            
            // Languages
            const languagesContainer = document.getElementById('languages-container');
            if (languagesContainer && profile.languages && profile.languages.length > 0) {
                languagesContainer.innerHTML = '';
                
                profile.languages.forEach(language => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = language;
                    languagesContainer.appendChild(tag);
                });
            }
            
            // Interests
            const interestsContainer = document.getElementById('interests-container');
            if (interestsContainer && profile.interests && profile.interests.length > 0) {
                interestsContainer.innerHTML = '';
                
                profile.interests.forEach(interest => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = interest;
                    interestsContainer.appendChild(tag);
                });
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to notifications container
            const container = document.querySelector('.notifications-container');
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Edit Profile Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const editButton = document.getElementById('edit-profile-btn');
            const modal = document.getElementById('edit-profile-modal');
            const closeButton = modal.querySelector('.close-modal');
            const form = document.getElementById('edit-profile-form');
            
            let currentProfile = null;
            
            // Open modal when edit button is clicked
            editButton.addEventListener('click', function() {
                if (!currentProfile) {
                    // Try to get profile data from local storage if not already loaded
                    const userInfoStr = localStorage.getItem('userInfo');
                    if (userInfoStr) {
                        const userInfo = JSON.parse(userInfoStr);
                        currentProfile = userInfo.profile || {};
                    }
                }
                
                // Populate form with current profile data
                populateEditForm(currentProfile);
                
                // Show modal
                modal.style.display = 'block';
                document.body.classList.add('modal-open');
            });
            
            // Close modal when X is clicked
            closeButton.addEventListener('click', function() {
                modal.style.display = 'none';
                document.body.classList.remove('modal-open');
            });
            
            // Close modal when clicking outside of it
            window.addEventListener('click', function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                }
            });
            
            // Handle form submission
            form.addEventListener('submit', async function(event) {
                event.preventDefault();
                
                // Define originalButtonText outside the try block so it's accessible in finally
                const submitButton = form.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.textContent;
                
                try {
                    // Show loading state
                    submitButton.textContent = 'Saving...';
                    submitButton.disabled = true;
                    
                    // Gather form data
                    const formData = {
                        displayName: document.getElementById('edit-display-name').value,
                        bio: document.getElementById('edit-bio').value,
                        avatar: document.getElementById('edit-avatar').value,
                        preferences: {
                            playStyle: document.getElementById('edit-play-style').value,
                            communication: document.getElementById('edit-communication').value,
                            playTime: document.getElementById('edit-play-time').value,
                            region: document.getElementById('edit-region').value
                        }
                    };
                    
                    // Handle languages (comma separated string to array)
                    const languagesStr = document.getElementById('edit-languages').value;
                    if (languagesStr.trim()) {
                        formData.languages = languagesStr.split(',').map(lang => lang.trim());
                    }
                    
                    // Handle interests (comma separated string to array)
                    const interestsStr = document.getElementById('edit-interests').value;
                    if (interestsStr.trim()) {
                        formData.interests = interestsStr.split(',').map(interest => interest.trim());
                    }
                    
                    console.log('Updating profile with data:', formData);
                    
                    // Call the API to update profile
                    let updatedProfile;
                    
                    try {
                        // Try direct database update first using fetch
                        const token = localStorage.getItem('token');
                        if (!token) {
                            throw new Error('Not authenticated');
                        }
                        
                        // Make sure avatar field is included explicitly
                        const profileDataForDb = {
                            ...formData,
                            avatar: formData.avatar || '', // Ensure avatar is included even if empty
                        };
                        
                        console.log('Sending to database:', profileDataForDb);
                        
                        const response = await fetch(`${window.APP_CONFIG.API_URL}/users/profile`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                            },
                            body: JSON.stringify(profileDataForDb),
                        });
                        
                        const data = await response.json();
                        
                        if (!response.ok) {
                            console.error('Server returned error:', data);
                            throw new Error(data.message || 'Failed to update profile in database');
                        }
                        
                        console.log('Database updated successfully:', data);
                        updatedProfile = data;
                        
                        // Also try to update via the Profile API as a backup
                        if (typeof window.Profile !== 'undefined' && typeof window.Profile.createOrUpdateProfile === 'function') {
                            try {
                                await window.Profile.createOrUpdateProfile(profileDataForDb);
                                console.log('Also updated via Profile API');
                            } catch (apiError) {
                                console.warn('Profile API update failed, but direct database update succeeded:', apiError);
                            }
                        }
                    } catch (dbError) {
                        console.error('Direct database update failed:', dbError);
                        
                        // Fall back to Profile API if direct update failed
                        if (typeof window.Profile !== 'undefined' && typeof window.Profile.createOrUpdateProfile === 'function') {
                            try {
                                updatedProfile = await window.Profile.createOrUpdateProfile(formData);
                                console.log('Profile updated via API fallback:', updatedProfile);
                            } catch (apiError) {
                                console.error('API fallback also failed:', apiError);
                                throw new Error('Failed to update profile: ' + dbError.message);
                            }
                        } else {
                            throw dbError; // Re-throw if no fallback available
                        }
                    }
                    
                    // Merge the updated profile with form data to ensure we have complete data
                    // This handles cases where the API might not return all fields we sent
                    const mergedProfile = {
                        ...formData,
                        ...updatedProfile,
                        // Ensure preferences are preserved if not returned by API
                        preferences: {
                            ...formData.preferences,
                            ...(updatedProfile.preferences || {})
                        }
                    };
                    
                    // Update current profile
                    currentProfile = mergedProfile;
                    
                    // Update localStorage with new profile data
                    try {
                        const userInfoStr = localStorage.getItem('userInfo');
                        if (userInfoStr) {
                            const userInfo = JSON.parse(userInfoStr);
                            userInfo.profile = mergedProfile;
                            localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        }
                    } catch (storageError) {
                        console.warn('Could not update localStorage:', storageError);
                    }
                    
                    // Force a complete page reload to ensure data is refreshed from server
                    showNotification('Profile updated successfully! Reloading page...', 'success');
                    
                    // Update UI immediately before reload
                    updateProfileUI(mergedProfile);
                    
                    // Close modal
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    
                    // Reload the page after a short delay to allow notification to be seen
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                    
                } catch (error) {
                    console.error('Error updating profile:', error);
                    showNotification('Failed to update profile: ' + error.message, 'error');
                } finally {
                    // Restore button state - now originalButtonText is always defined
                    submitButton.textContent = originalButtonText;
                    submitButton.disabled = false;
                }
            });
            
            // Function to populate the edit form with current profile data
            function populateEditForm(profile) {
                if (!profile) return;
                
                console.log('Populating form with profile data:', profile);
                
                // Basic info
                document.getElementById('edit-display-name').value = profile.displayName || '';
                document.getElementById('edit-bio').value = profile.bio || '';
                
                // Handle avatar - check if it's stored directly or in nested objects
                let avatarUrl = '';
                if (profile.avatar) {
                    avatarUrl = profile.avatar;
                } else if (profile.profile && profile.profile.avatar) {
                    avatarUrl = profile.profile.avatar;
                }
                document.getElementById('edit-avatar').value = avatarUrl;
                
                // Handle preferences from different possible locations
                const preferences = profile.preferences || 
                                   (profile.profile ? profile.profile.preferences : {}) || 
                                   {};
                                   
                // Set preference values with fallbacks
                document.getElementById('edit-play-style').value = 
                    preferences.playStyle || 'Casual';
                    
                document.getElementById('edit-communication').value = 
                    preferences.communication || 'Both';
                    
                document.getElementById('edit-play-time').value = 
                    preferences.playTime || 'Evening';
                    
                document.getElementById('edit-region').value = 
                    preferences.region || 'North America';
                
                // Find languages in profile or profile.profile
                const languages = profile.languages || 
                                 (profile.profile ? profile.profile.languages : []) || 
                                 [];
                                 
                if (Array.isArray(languages) && languages.length > 0) {
                    document.getElementById('edit-languages').value = languages.join(', ');
                }
                
                // Find interests in profile or profile.profile
                const interests = profile.interests || 
                                 (profile.profile ? profile.profile.interests : []) || 
                                 [];
                                 
                if (Array.isArray(interests) && interests.length > 0) {
                    document.getElementById('edit-interests').value = interests.join(', ');
                }
            }
        });
    </script>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
        }
        
        .modal-content {
            background-color: var(--surface);
            margin: 50px auto;
            max-width: 700px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            animation: modal-appear 0.3s ease;
        }
        
        @keyframes modal-appear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }
        
        .close-modal {
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--accent);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-group.half {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 16px;
            background-color: var(--surface-variant);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Button styles - enhanced for profile page */
        .btn-primary {
            padding: 10px 20px;
            background-color: var(--accent);
            color: var(--text-on-accent);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary:hover {
            background-color: var(--accent-hover);
            transform: translateY(-2px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        /* Profile edit button */
        #edit-profile-btn {
            margin-top: 15px;
        }
        
        /* Glow effect for button */
        .glow-on-hover {
            position: relative;
            overflow: hidden;
        }
        
        .glow-on-hover:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, rgba(0,0,0,0) 70%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .glow-on-hover:hover:after {
            opacity: 1;
        }
        
        body.modal-open {
            overflow: hidden;
        }
    </style>
</body>
</html> 