<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | GameSquad</title>
    
    <!-- Unified Theme System -->
    <link rel="stylesheet" href="../css/gamesquad-theme.css">
    <link rel="stylesheet" href="../css/animations.css">
    <link rel="stylesheet" href="../css/gaming-styles.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/profile.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/profile.js"></script>
    <script src="../js/friends-service.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/moment.min.js"></script>
    <script src="../js/axios.min.js"></script>
    <script src="../js/gamesquad-ui.js"></script>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1 class="sheen">GameSquad</h1>
            </div>
            <ul class="nav-links">
                <li><a href="../home.html">Home</a></li>
                <li><a href="lobbies.html">Lobbies</a></li>
                <li><a href="players.html">Players</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="user-profile">
                <span class="username">Username <i class="fas fa-chevron-down"></i></span>
                <div class="profile-dropdown">
                    <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                    <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
                    <a href="#" class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="page-title">
            <h1 class="neon-text">MY PROFILE</h1>
        </div>

        <div class="profile-container fade-element">
            <div class="profile-content fade-stagger">
                <!-- Profile Card Section -->
                <div class="profile-card glow-effect">
                    <div class="profile-image-container">
                        <div class="avatar-wrapper">
                            <img id="profile-avatar" src="../resources/default-avatar.png" alt="Profile Avatar" class="profile-avatar">
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-display-name">Loading...</h2>
                        <p id="profile-username" class="profile-username">@username</p>
                        <p id="profile-bio" class="profile-bio">Loading bio...</p>
                        <div class="profile-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="profile-joined">Joined: Loading...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-gamepad"></i>
                                <span id="profile-games-played">Games: 0</span>
                            </div>
                        </div>
                        <button id="edit-profile-btn" class="btn-primary glow-on-hover" onclick="showEditProfileModal(); return false;">
                            <i class="fas fa-edit"></i> Edit Profile
                        </button>
                    </div>
                </div>

                <!-- Game Ranks Section -->
                <div class="profile-section game-ranks-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-medal"></i> GAME RANKS</h3>
                    <div id="game-ranks-container" class="game-ranks-grid">
                        <!-- Game ranks will be added here dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-gamepad"></i>
                            <p>No game ranks added yet</p>
                        </div>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="profile-section preferences-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-sliders-h"></i> PREFERENCES</h3>
                    <div class="preferences-grid">
                        <div class="preference-item">
                            <h4>Play Style</h4>
                            <p id="pref-play-style">Casual</p>
                        </div>
                        <div class="preference-item">
                            <h4>Communication</h4>
                            <p id="pref-communication">Both</p>
                        </div>
                        <div class="preference-item">
                            <h4>Play Time</h4>
                            <p id="pref-play-time">Evening</p>
                        </div>
                        <div class="preference-item">
                            <h4>Region</h4>
                            <p id="pref-region">North America</p>
                        </div>
                    </div>
                </div>

                <!-- Languages & Interests Section -->
                <div class="profile-section dual-section glow-effect">
                    <div class="languages-section">
                        <h3 class="section-title"><i class="fas fa-language"></i> LANGUAGES</h3>
                        <div id="languages-container" class="tags-container">
                            <!-- Languages will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i>
                                <p>No languages added</p>
                            </div>
                        </div>
                    </div>
                    <div class="interests-section">
                        <h3 class="section-title"><i class="fas fa-heart"></i> INTERESTS</h3>
                        <div id="interests-container" class="tags-container">
                            <!-- Interests will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-heart-broken"></i>
                                <p>No interests added</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2 class="neon-text">GameSquad</h2>
                    <p>Find your perfect gaming team</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Navigation</h3>
                        <ul>
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="lobbies.html">Lobbies</a></li>
                            <li><a href="players.html">Players</a></li>
                            <li><a href="profile.html">Profile</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Legal</h3>
                        <ul>
                            <li><a href="terms.html">Terms of Service</a></li>
                            <li><a href="privacy.html">Privacy Policy</a></li>
                            <li><a href="cookies.html">Cookie Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="faq.html">FAQ</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                            <li><a href="report-bug.html">Report a Bug</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer-social">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="#" class="power-button"><i class="fab fa-discord"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 GameSquad. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Notifications Container -->
    <div class="notifications-container"></div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Profile</h2>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-profile-form">
                    <div class="form-group">
                        <label for="edit-display-name">Display Name</label>
                        <input type="text" id="edit-display-name" name="displayName" placeholder="Your display name">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-bio">Bio</label>
                        <textarea id="edit-bio" name="bio" placeholder="Tell us about yourself"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-avatar">Avatar URL</label>
                        <input type="text" id="edit-avatar" name="avatar" placeholder="URL to your avatar image">
                    </div>
                    
                    <h3>Preferences</h3>
                    
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="edit-play-style">Play Style</label>
                            <select id="edit-play-style" name="playStyle">
                                <option value="Casual">Casual</option>
                                <option value="Competitive">Competitive</option>
                                <option value="Mix">Mix</option>
                            </select>
                        </div>
                        
                        <div class="form-group half">
                            <label for="edit-communication">Communication</label>
                            <select id="edit-communication" name="communication">
                                <option value="Voice">Voice</option>
                                <option value="Text">Text</option>
                                <option value="Both">Both</option>
                                <option value="None">None</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group half">
                            <label for="edit-play-time">Play Time</label>
                            <select id="edit-play-time" name="playTime">
                                <option value="Morning">Morning</option>
                                <option value="Afternoon">Afternoon</option>
                                <option value="Evening">Evening</option>
                                <option value="Night">Night</option>
                                <option value="Weekends">Weekends</option>
                                <option value="Flexible">Flexible</option>
                            </select>
                        </div>
                        
                        <div class="form-group half">
                            <label for="edit-region">Region</label>
                            <select id="edit-region" name="region">
                                <option value="North America">North America</option>
                                <option value="Europe">Europe</option>
                                <option value="Asia">Asia</option>
                                <option value="South America">South America</option>
                                <option value="Oceania">Oceania</option>
                                <option value="Africa">Africa</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-languages">Languages (comma separated)</label>
                        <input type="text" id="edit-languages" name="languages" placeholder="English, Spanish, etc.">
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-interests">Interests (comma separated)</label>
                        <input type="text" id="edit-interests" name="interests" placeholder="RPGs, FPS, Strategy, etc.">
                    </div>
                    
                    <h3>Game Ranks</h3>
                    <div class="form-group">
                        <div id="game-ranks-editor">
                            <!-- Existing game ranks will be added here -->
                        </div>
                        <div class="game-rank-add">
                            <div class="form-row">
                                <div class="form-group half">
                                    <input type="text" id="new-game-name" placeholder="Game name">
                                </div>
                                <div class="form-group half">
                                    <input type="text" id="new-game-rank" placeholder="Your rank">
                                </div>
                            </div>
                            <button type="button" id="add-game-rank" class="btn-secondary">
                                <i class="fas fa-plus"></i> Add Game
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <button type="submit" class="btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main JS -->
    <script src="../js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize animation elements
            const fadeElements = document.querySelectorAll('.fade-element');
            fadeElements.forEach(element => {
                element.classList.add('appear');
            });

            setTimeout(() => {
                const staggerElements = document.querySelectorAll('.fade-stagger');
                staggerElements.forEach(element => {
                    element.classList.add('appear');
                });
            }, 300);

            // Load user profile data
            loadUserProfile();
            
            // Set up tabs if the function exists
            if (typeof window.Profile !== 'undefined' && typeof window.Profile.setupTabs === 'function') {
                window.Profile.setupTabs();
            } else {
                console.log('setupTabs function not available');
            }

            // Edit Profile Functionality
            const editButton = document.getElementById('edit-profile-btn');
            const modal = document.getElementById('edit-profile-modal');
            
            // Expose the populateEditForm function globally so it can be called from onclick
            window.populateEditForm = function(profile) {
                if (!profile) return;
                
                // Basic fields
                const displayNameField = document.getElementById('edit-display-name');
                const bioField = document.getElementById('edit-bio');
                const avatarField = document.getElementById('edit-avatar');
                
                if (displayNameField) displayNameField.value = profile.displayName || '';
                if (bioField) bioField.value = profile.bio || '';
                if (avatarField) avatarField.value = profile.avatar || '';
                
                // Preferences
                const playStyleField = document.getElementById('edit-play-style');
                const communicationField = document.getElementById('edit-communication');
                const playTimeField = document.getElementById('edit-play-time');
                const regionField = document.getElementById('edit-region');
                
                const prefs = profile.preferences || {};
                
                if (playStyleField && prefs.playStyle) playStyleField.value = prefs.playStyle;
                if (communicationField && prefs.communication) communicationField.value = prefs.communication;
                if (playTimeField && prefs.playTime) playTimeField.value = prefs.playTime;
                if (regionField && prefs.region) regionField.value = prefs.region;
                
                // Languages and interests
                const languagesField = document.getElementById('edit-languages');
                const interestsField = document.getElementById('edit-interests');
                
                if (languagesField && profile.languages && Array.isArray(profile.languages)) {
                    languagesField.value = profile.languages.join(', ');
                }
                
                if (interestsField && profile.interests && Array.isArray(profile.interests)) {
                    interestsField.value = profile.interests.join(', ');
                }
                
                // Game ranks
                const gameRanksEditor = document.getElementById('game-ranks-editor');
                if (gameRanksEditor && profile.gameRanks && Array.isArray(profile.gameRanks)) {
                    // Clear existing game ranks
                    gameRanksEditor.innerHTML = '';
                    
                    // Add each game rank
                    profile.gameRanks.forEach(gameRank => {
                        if (gameRank.game && gameRank.rank) {
                            const gameRankItem = document.createElement('div');
                            gameRankItem.className = 'game-rank-item';
                            gameRankItem.innerHTML = `
                                <div class="form-row">
                                    <div class="form-group half">
                                        <input type="text" class="game-name" value="${gameRank.game}" placeholder="Game name">
                                    </div>
                                    <div class="form-group half">
                                        <input type="text" class="game-rank" value="${gameRank.rank}" placeholder="Your rank">
                                    </div>
                                    <button type="button" class="remove-game-rank btn-icon">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            `;
                            
                            // Add remove event listener
                            const removeButton = gameRankItem.querySelector('.remove-game-rank');
                            if (removeButton) {
                                removeButton.addEventListener('click', function() {
                                    gameRankItem.remove();
                                });
                            }
                            
                            gameRanksEditor.appendChild(gameRankItem);
                        }
                    });
                }
            };
            
            // Setup normal edit profile button functionality alongside the direct onclick
            if (editButton && modal) {
                const closeButton = modal.querySelector('.close-modal');
                const form = document.getElementById('edit-profile-form');
                
                // Setup game rank add button
                const addGameRankButton = document.getElementById('add-game-rank');
                if (addGameRankButton) {
                    addGameRankButton.addEventListener('click', function() {
                        const gameNameField = document.getElementById('new-game-name');
                        const gameRankField = document.getElementById('new-game-rank');
                        const gameRanksEditor = document.getElementById('game-ranks-editor');
                        
                        if (!gameNameField || !gameRankField || !gameRanksEditor) return;
                        
                        const gameName = gameNameField.value.trim();
                        const gameRank = gameRankField.value.trim();
                        
                        if (!gameName || !gameRank) {
                            showNotification('Please enter both game name and rank', 'warning');
                            return;
                        }
                        
                        // Create rank item
                        const gameRankItem = document.createElement('div');
                        gameRankItem.className = 'game-rank-item';
                        gameRankItem.innerHTML = `
                            <div class="form-row">
                                <div class="form-group half">
                                    <input type="text" class="game-name" value="${gameName}" placeholder="Game name">
                                </div>
                                <div class="form-group half">
                                    <input type="text" class="game-rank" value="${gameRank}" placeholder="Your rank">
                                </div>
                                <button type="button" class="remove-game-rank btn-icon">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `;
                        
                        // Add remove listener
                        const removeButton = gameRankItem.querySelector('.remove-game-rank');
                        if (removeButton) {
                            removeButton.addEventListener('click', function() {
                                gameRankItem.remove();
                            });
                        }
                        
                        gameRanksEditor.appendChild(gameRankItem);
                        
                        // Clear fields
                        gameNameField.value = '';
                        gameRankField.value = '';
                    });
                }
                
                // Close button handler
                if (closeButton) {
                    closeButton.addEventListener('click', function() {
                        modal.style.display = 'none';
                        document.body.classList.remove('modal-open');
                    });
                }
                
                // Form submission
                if (form) {
                    form.addEventListener('submit', async function(event) {
                        event.preventDefault();
                        
                        const submitButton = form.querySelector('button[type="submit"]');
                        const originalButtonText = submitButton.textContent;
                        
                        try {
                            // Show loading
                            submitButton.textContent = 'Saving...';
                            submitButton.disabled = true;
                            
                            // Gather data
                            const formData = {
                                displayName: document.getElementById('edit-display-name').value,
                                bio: document.getElementById('edit-bio').value,
                                avatar: document.getElementById('edit-avatar').value,
                                preferences: {
                                    playStyle: document.getElementById('edit-play-style').value,
                                    communication: document.getElementById('edit-communication').value,
                                    playTime: document.getElementById('edit-play-time').value,
                                    region: document.getElementById('edit-region').value
                                }
                            };
                            
                            // Process languages
                            const languagesStr = document.getElementById('edit-languages').value;
                            if (languagesStr.trim()) {
                                formData.languages = languagesStr.split(',').map(lang => lang.trim());
                            }
                            
                            // Process interests
                            const interestsStr = document.getElementById('edit-interests').value;
                            if (interestsStr.trim()) {
                                formData.interests = interestsStr.split(',').map(interest => interest.trim());
                            }
                            
                            // Process game ranks
                            formData.gameRanks = [];
                            document.querySelectorAll('.game-rank-item').forEach(item => {
                                const gameName = item.querySelector('.game-name').value.trim();
                                const gameRank = item.querySelector('.game-rank').value.trim();
                                
                                if (gameName && gameRank) {
                                    formData.gameRanks.push({
                                        game: gameName,
                                        rank: gameRank
                                    });
                                }
                            });
                            
                            console.log('Updating profile with data:', formData);
                            
                            // Update profile
                            if (window.Profile && typeof window.Profile.createOrUpdateProfile === 'function') {
                                await window.Profile.createOrUpdateProfile(formData);
                                
                                // Success
                                showNotification('Profile updated successfully! Reloading page...', 'success');
                                
                                // Close modal
                                modal.style.display = 'none';
                                document.body.classList.remove('modal-open');
                                
                                // Reload
                                setTimeout(() => {
                                    window.location.reload();
                                }, 1500);
                            } else {
                                // Direct API call
                                const token = localStorage.getItem('token');
                                const response = await fetch(`${window.APP_CONFIG.API_URL}/users/profile`, {
                                    method: 'PUT',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}`
                                    },
                                    body: JSON.stringify(formData)
                                });
                                
                                if (response.ok) {
                                    // Success
                                    showNotification('Profile updated successfully! Reloading page...', 'success');
                                    
                                    // Close modal
                                    modal.style.display = 'none';
                                    document.body.classList.remove('modal-open');
                                    
                                    // Reload
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);
                                } else {
                                    throw new Error('Failed to update profile');
                                }
                            }
                        } catch (error) {
                            console.error('Error updating profile:', error);
                            showNotification('Failed to update profile: ' + error.message, 'error');
                        } finally {
                            // Restore button
                            submitButton.textContent = originalButtonText;
                            submitButton.disabled = false;
                        }
                    });
                }
            }
        });

        // Load user profile data from database
        async function loadUserProfile() {
            try {
                // Check if user is logged in - fix the function reference issue
                // Try multiple possible locations of the function
                let isUserLoggedIn = false;
                
                if (typeof window.Auth !== 'undefined') {
                    if (typeof window.Auth.isLoggedIn === 'function') {
                        isUserLoggedIn = window.Auth.isLoggedIn();
                    } else if (typeof window.isLoggedIn === 'function') {
                        isUserLoggedIn = window.isLoggedIn();
                    } else if (typeof window.AUTH !== 'undefined' && typeof window.AUTH.isLoggedIn === 'function') {
                        isUserLoggedIn = window.AUTH.isLoggedIn();
                    } else {
                        // Fallback method - check if token exists
                        isUserLoggedIn = !!localStorage.getItem('token');
                    }
                } else {
                    // Fallback to checking token directly
                    isUserLoggedIn = !!localStorage.getItem('token');
                }
                
                if (!isUserLoggedIn) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Show loading state
                showLoadingState();
                
                let profileData;
                
                // Use getAllProfiles function to get all profiles from the database
                if (typeof window.Profile !== 'undefined' && typeof window.Profile.getAllProfiles === 'function') {
                    try {
                        console.log('Getting all profiles from Profile.getAllProfiles API');
                        const allProfiles = await window.Profile.getAllProfiles();
                        console.log('All profiles retrieved from API:', allProfiles);
                        
                        // Get the current user's ID
                        const userInfoStr = localStorage.getItem('userInfo');
                        if (!userInfoStr) {
                            throw new Error('No user info found. Please log in again.');
                        }
                        
                        const userInfo = JSON.parse(userInfoStr);
                        const currentUserId = userInfo._id || userInfo.id || userInfo.userId;
                        
                        // Find the current user's profile from all profiles
                        profileData = allProfiles.find(profile => 
                            profile._id === currentUserId || 
                            (profile.user && profile.user._id === currentUserId)
                        );
                        
                        if (!profileData && allProfiles.length > 0) {
                            // If we couldn't find the exact profile, use the first one (for demo purposes)
                            console.warn('Could not find exact profile match, using first profile');
                            profileData = allProfiles[0];
                            showNotification('Demo mode: Showing sample profile data', 'info');
                        }
                        
                        console.log('Current user profile found:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Profile.getAllProfiles:', apiError);
                        throw new Error('Failed to fetch profiles from API: ' + apiError.message);
                    }
                } 
                // Try to get profile using Auth.getUserProfile (fallback)
                else if (typeof window.Auth !== 'undefined' && typeof window.Auth.getUserProfile === 'function') {
                    try {
                        console.log('Getting profile from Auth.getUserProfile API');
                        profileData = await window.Auth.getUserProfile();
                        console.log('Profile retrieved from API:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Auth.getUserProfile:', apiError);
                        throw new Error('Failed to fetch profile from API: ' + apiError.message);
                    }
                } 
                // Fallback to Profile.getMyProfile if Auth.getUserProfile is not available
                else if (typeof window.Profile !== 'undefined' && typeof window.Profile.getMyProfile === 'function') {
                    try {
                        console.log('Getting profile from Profile.getMyProfile API');
                        profileData = await window.Profile.getMyProfile();
                        console.log('Profile retrieved from API:', profileData);
                    } catch (apiError) {
                        console.error('Error calling Profile.getMyProfile:', apiError);
                        throw new Error('Failed to fetch profile from API: ' + apiError.message);
                    }
                } 
                // If no APIs are available, get minimal data from localStorage
                else {
                    console.warn('No profile API functions available');
                    // Get minimal data from localStorage
                    const userInfoStr = localStorage.getItem('userInfo');
                    if (!userInfoStr) {
                        throw new Error('No user profile found. Please log in again.');
                    }
                    
                    const userInfo = JSON.parse(userInfoStr);
                    profileData = userInfo.profile || {
                        user: {
                            _id: userInfo._id,
                            username: userInfo.username,
                            email: userInfo.email
                        },
                        displayName: userInfo.username
                    };
                    
                    console.log('Using minimal profile data from localStorage');
                    showNotification('Limited profile data available. Some features may not work properly.', 'info');
                }
                
                console.log('Profile data loaded:', profileData);
                
                // Update UI with profile data
                updateProfileUI(profileData);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile: ' + error.message, 'error');
            }
        }
        
        // Show loading state in UI
        function showLoadingState() {
            // Set loading indicators for each section
            document.getElementById('profile-display-name').textContent = 'Loading...';
            document.getElementById('profile-username').textContent = '@loading';
            document.getElementById('profile-bio').textContent = 'Loading bio...';
        }
        
        // Update UI with profile data
        function updateProfileUI(profile) {
            // Basic user info
            const displayName = profile.displayName || (profile.user ? profile.user.username : 'User');
            const username = profile.user ? profile.user.username : '';
            
            document.getElementById('profile-display-name').textContent = displayName;
            document.getElementById('profile-username').textContent = username ? `@${username}` : '';
            
            // Profile image
            const avatarEl = document.getElementById('profile-avatar');
            if (avatarEl) {
                const avatarUrl = profile.avatar || '../resources/default-avatar.png';
                if (avatarUrl && !avatarUrl.startsWith('http')) {
                    avatarEl.src = `../${avatarUrl.startsWith('/') ? avatarUrl.substring(1) : avatarUrl}`;
                } else {
                    avatarEl.src = avatarUrl || '../resources/default-avatar.png';
                }
            }
            
            // Bio
            const bioEl = document.getElementById('profile-bio');
            if (bioEl) {
                bioEl.textContent = profile.bio || 'No bio provided';
            }
            
            // Join date
            const joinedEl = document.getElementById('profile-joined');
            if (joinedEl && profile.createdAt) {
                const date = new Date(profile.createdAt);
                joinedEl.textContent = `Joined: ${date.toLocaleDateString()}`;
            }
            
            // Games played count for the profile card
            if (profile.gamesPlayed !== undefined) {
                const gamesPlayedEl = document.getElementById('profile-games-played');
                if (gamesPlayedEl) {
                    gamesPlayedEl.textContent = `Games: ${profile.gamesPlayed}`;
                }
            }
            
            // Game ranks
            const gameRanksContainer = document.getElementById('game-ranks-container');
            if (gameRanksContainer) {
                // Find game ranks from either location in the data structure
                const gameRanks = profile.gameRanks || (profile.profile ? profile.profile.gameRanks : []) || [];
                
                if (Array.isArray(gameRanks) && gameRanks.length > 0) {
                    gameRanksContainer.innerHTML = ''; // Clear the container
                    
                    // Create game rank cards
                    gameRanks.forEach(gameRank => {
                        const gameRankCard = document.createElement('div');
                        gameRankCard.className = 'game-rank-card';
                        gameRankCard.innerHTML = `
                            <h4>${gameRank.game}</h4>
                            <div class="rank-badge">${gameRank.rank}</div>
                        `;
                        gameRanksContainer.appendChild(gameRankCard);
                    });
                } else {
                    // Show empty state
                    gameRanksContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-gamepad"></i>
                            <p>No game ranks added yet</p>
                        </div>
                    `;
                }
            }
            
            // Preferences
            if (profile.preferences) {
                if (profile.preferences.playStyle) {
                    document.getElementById('pref-play-style').textContent = profile.preferences.playStyle;
                }
                
                if (profile.preferences.communication) {
                    document.getElementById('pref-communication').textContent = profile.preferences.communication;
                }
                
                if (profile.preferences.playTime) {
                    document.getElementById('pref-play-time').textContent = profile.preferences.playTime;
                }
                
                if (profile.preferences.region) {
                    document.getElementById('pref-region').textContent = profile.preferences.region;
                }
            }
            
            // Languages
            const languagesContainer = document.getElementById('languages-container');
            if (languagesContainer && profile.languages && profile.languages.length > 0) {
                languagesContainer.innerHTML = '';
                
                profile.languages.forEach(language => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = language;
                    languagesContainer.appendChild(tag);
                });
            }
            
            // Interests
            const interestsContainer = document.getElementById('interests-container');
            if (interestsContainer && profile.interests && profile.interests.length > 0) {
                interestsContainer.innerHTML = '';
                
                profile.interests.forEach(interest => {
                    const tag = document.createElement('span');
                    tag.className = 'tag';
                    tag.textContent = interest;
                    interestsContainer.appendChild(tag);
                });
            }
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to notifications container
            const container = document.querySelector('.notifications-container');
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }

        // Global function to show edit profile modal when button is clicked directly
        function showEditProfileModal() {
            console.log('Direct edit profile button click function called');
            
            // Get current profile data
            let currentProfile = null;
            const userInfoStr = localStorage.getItem('userInfo');
            if (userInfoStr) {
                const userInfo = JSON.parse(userInfoStr);
                currentProfile = userInfo.profile || {};
            }
            
            // Get the modal element
            const modal = document.getElementById('edit-profile-modal');
            if (!modal) {
                console.error('Edit profile modal not found');
                return;
            }
            
            // Try to load the populate function
            let populateEditFormFn = window.populateEditForm;
            
            // If the function exists, call it
            if (typeof populateEditFormFn === 'function') {
                populateEditFormFn(currentProfile);
            } else {
                console.log('Populate edit form function not found globally');
                
                // Try to find it in the page
                const scripts = document.querySelectorAll('script');
                let foundPopulateFunction = false;
                
                scripts.forEach(script => {
                    if (script.textContent.includes('function populateEditForm')) {
                        foundPopulateFunction = true;
                    }
                });
                
                console.log('Function found in page scripts:', foundPopulateFunction);
                
                // Direct field population as fallback
                try {
                    if (currentProfile) {
                        // Basic fields
                        const fields = {
                            'edit-display-name': currentProfile.displayName || '',
                            'edit-bio': currentProfile.bio || '',
                            'edit-avatar': currentProfile.avatar || ''
                        };
                        
                        // Set field values
                        Object.keys(fields).forEach(id => {
                            const field = document.getElementById(id);
                            if (field) {
                                field.value = fields[id];
                            }
                        });
                        
                        // Preferences
                        const prefs = currentProfile.preferences || {};
                        
                        const prefFields = {
                            'edit-play-style': prefs.playStyle || 'Casual',
                            'edit-communication': prefs.communication || 'Text',
                            'edit-play-time': prefs.playTime || 'Evening',
                            'edit-region': prefs.region || 'North America'
                        };
                        
                        Object.keys(prefFields).forEach(id => {
                            const field = document.getElementById(id);
                            if (field) {
                                field.value = prefFields[id];
                            }
                        });
                        
                        // Languages and interests
                        const languagesField = document.getElementById('edit-languages');
                        if (languagesField && currentProfile.languages && Array.isArray(currentProfile.languages)) {
                            languagesField.value = currentProfile.languages.join(', ');
                        }
                        
                        const interestsField = document.getElementById('edit-interests');
                        if (interestsField && currentProfile.interests && Array.isArray(currentProfile.interests)) {
                            interestsField.value = currentProfile.interests.join(', ');
                        }
                        
                        // Game ranks
                        const gameRanksEditor = document.getElementById('game-ranks-editor');
                        if (gameRanksEditor && currentProfile.gameRanks && Array.isArray(currentProfile.gameRanks)) {
                            // Clear existing ranks
                            gameRanksEditor.innerHTML = '';
                            
                            // Add each rank
                            currentProfile.gameRanks.forEach(rank => {
                                if (rank.game && rank.rank) {
                                    const html = `
                                        <div class="game-rank-item">
                                            <div class="form-row">
                                                <div class="form-group half">
                                                    <input type="text" class="game-name" value="${rank.game}" placeholder="Game name">
                                                </div>
                                                <div class="form-group half">
                                                    <input type="text" class="game-rank" value="${rank.rank}" placeholder="Your rank">
                                                </div>
                                                <button type="button" class="remove-game-rank btn-icon">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                    
                                    // Add to editor
                                    gameRanksEditor.insertAdjacentHTML('beforeend', html);
                                }
                            });
                            
                            // Add event listeners to remove buttons
                            const removeButtons = gameRanksEditor.querySelectorAll('.remove-game-rank');
                            removeButtons.forEach(button => {
                                button.addEventListener('click', function() {
                                    this.closest('.game-rank-item').remove();
                                });
                            });
                        }
                    }
                } catch (err) {
                    console.error('Error directly populating form:', err);
                }
            }
            
            // Display modal
            modal.style.display = 'block';
            modal.style.opacity = '1';
            modal.style.visibility = 'visible';
            document.body.classList.add('modal-open');
            
            // Add event listener for clicking outside modal to close it
            document.addEventListener('click', function closeModal(e) {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    document.body.classList.remove('modal-open');
                    document.removeEventListener('click', closeModal);
                }
            });
            
            // Check if modal is visible
            setTimeout(() => {
                const isVisible = modal.offsetWidth > 0 && modal.offsetHeight > 0 && 
                                 window.getComputedStyle(modal).display !== 'none';
                
                console.log('Direct modal visibility check:', isVisible);
                
                // If not visible, use fallback
                if (!isVisible) {
                    // Create fallback modal
                    showFallbackEditModalDirect(currentProfile);
                }
            }, 300);
        }
        
        // Direct fallback modal function
        function showFallbackEditModalDirect(profileData) {
            console.log('Creating direct fallback modal');
            
            // Create modal container
            const fallbackModal = document.createElement('div');
            fallbackModal.id = 'direct-fallback-modal';
            fallbackModal.style.position = 'fixed';
            fallbackModal.style.top = '0';
            fallbackModal.style.left = '0';
            fallbackModal.style.width = '100%';
            fallbackModal.style.height = '100%';
            fallbackModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            fallbackModal.style.zIndex = '3000';
            fallbackModal.style.display = 'flex';
            fallbackModal.style.justifyContent = 'center';
            fallbackModal.style.alignItems = 'center';
            
            // Get the original modal content to clone
            const originalContent = document.getElementById('edit-profile-modal').querySelector('.modal-content');
            
            // Create content if original not found
            let contentClone;
            if (originalContent) {
                contentClone = originalContent.cloneNode(true);
            } else {
                contentClone = document.createElement('div');
                contentClone.className = 'modal-content';
                contentClone.style.backgroundColor = '#1a1a2e';
                contentClone.style.padding = '20px';
                contentClone.style.borderRadius = '8px';
                contentClone.style.maxWidth = '600px';
                contentClone.style.width = '90%';
                contentClone.style.maxHeight = '80vh';
                contentClone.style.overflowY = 'auto';
                
                contentClone.innerHTML = `
                    <div class="modal-header">
                        <h2>Edit Profile</h2>
                        <span class="close-modal">&times;</span>
                    </div>
                    <div class="modal-body">
                        <form id="fallback-edit-form">
                            <div class="form-group">
                                <label>Display Name</label>
                                <input type="text" id="fb-display-name" value="${profileData?.displayName || ''}">
                            </div>
                            <div class="form-group">
                                <label>Bio</label>
                                <textarea id="fb-bio">${profileData?.bio || ''}</textarea>
                            </div>
                            <div class="form-group">
                                <label>Avatar URL</label>
                                <input type="text" id="fb-avatar" value="${profileData?.avatar || ''}">
                            </div>
                            <button type="submit" style="background-color: #4e54c8; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer;">
                                Save Changes
                            </button>
                        </form>
                    </div>
                `;
            }
            
            // Add content to modal
            fallbackModal.appendChild(contentClone);
            
            // Add to body
            document.body.appendChild(fallbackModal);
            
            // Set up close button
            const closeBtn = contentClone.querySelector('.close-modal');
            if (closeBtn) {
                closeBtn.addEventListener('click', () => {
                    document.body.removeChild(fallbackModal);
                });
            }
            
            // Set up click outside to close
            fallbackModal.addEventListener('click', (e) => {
                if (e.target === fallbackModal) {
                    document.body.removeChild(fallbackModal);
                }
            });
            
            // Set up form submit
            const form = contentClone.querySelector('form');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    try {
                        let formData;
                        
                        // Get data based on which form we have
                        if (form.id === 'fallback-edit-form') {
                            formData = {
                                displayName: document.getElementById('fb-display-name').value,
                                bio: document.getElementById('fb-bio').value,
                                avatar: document.getElementById('fb-avatar').value
                            };
                        } else {
                            // Get data from the cloned form
                            const displayNameField = form.querySelector('#edit-display-name') || form.querySelector('[name="displayName"]');
                            const bioField = form.querySelector('#edit-bio') || form.querySelector('[name="bio"]');
                            const avatarField = form.querySelector('#edit-avatar') || form.querySelector('[name="avatar"]');
                            
                            formData = {
                                displayName: displayNameField ? displayNameField.value : '',
                                bio: bioField ? bioField.value : '',
                                avatar: avatarField ? avatarField.value : ''
                            };
                        }
                        
                        console.log('Updating profile with fallback form data:', formData);
                        
                        // Update the profile
                        if (window.Profile && typeof window.Profile.createOrUpdateProfile === 'function') {
                            await window.Profile.createOrUpdateProfile(formData);
                            alert('Profile updated successfully!');
                            window.location.reload();
                        } else {
                            // Direct API call fallback
                            const token = localStorage.getItem('token');
                            const response = await fetch(`${window.APP_CONFIG.API_URL}/users/profile`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify(formData)
                            });
                            
                            if (response.ok) {
                                alert('Profile updated successfully!');
                                window.location.reload();
                            } else {
                                throw new Error('Failed to update profile');
                            }
                        }
                    } catch (err) {
                        console.error('Error updating profile:', err);
                        alert('Failed to update profile: ' + err.message);
                    }
                });
            }
        }
    </script>

    <style>
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            overflow-y: auto;
            opacity: 1;
            visibility: visible;
        }
        
        body.modal-open .modal {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .modal-content {
            background-color: var(--surface);
            margin: 50px auto;
            max-width: 700px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            animation: modal-appear 0.3s ease;
            position: relative;
            z-index: 1001;
        }
        
        @keyframes modal-appear {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            color: var(--text-primary);
            font-size: 1.5rem;
        }
        
        .close-modal {
            font-size: 28px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .close-modal:hover {
            color: var(--accent);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .form-group.half {
            flex: 1;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px 12px;
            font-size: 16px;
            background-color: var(--surface-variant);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 5px rgba(0, 255, 255, 0.3);
            outline: none;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Button styles - enhanced for profile page */
        .btn-primary, .btn-secondary, .btn-danger {
            padding: 10px 20px;
            color: var(--text-on-accent);
            border: none;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--accent);
        }
        
        .btn-secondary {
            background-color: #5c6bc0;
        }
        
        .btn-danger {
            background-color: #e53935;
            padding: 5px 10px;
            font-size: 14px;
        }
        
        .btn-primary:hover, .btn-secondary:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary:hover {
            background-color: var(--accent-hover);
        }
        
        .btn-secondary:hover {
            background-color: #3949ab;
        }
        
        .btn-danger:hover {
            background-color: #c62828;
        }
        
        .btn-primary:active, .btn-secondary:active, .btn-danger:active {
            transform: translateY(0);
        }
        
        /* Profile edit button */
        #edit-profile-btn {
            margin-top: 15px;
        }
        
        /* Glow effect for button */
        .glow-on-hover {
            position: relative;
            overflow: hidden;
        }
        
        .glow-on-hover:after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0,255,255,0.2) 0%, rgba(0,0,0,0) 70%);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        .glow-on-hover:hover:after {
            opacity: 1;
        }
        
        /* Game Ranks Editor Styles */
        .game-rank-item {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid var(--border);
        }
        
        .game-rank-item .form-row {
            margin-bottom: 0;
        }
        
        .game-rank-add {
            margin-top: 15px;
        }
        
        body.modal-open {
            overflow: hidden;
        }
    </style>
</body>
</html> 