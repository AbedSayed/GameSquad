<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | GameSquad</title>
    
    <!-- Unified Theme System -->
    <link rel="stylesheet" href="../css/gamesquad-theme.css">
    <link rel="stylesheet" href="../css/animations.css">
    <link rel="stylesheet" href="../css/gaming-styles.css">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/profile.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Exo+2:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Scripts -->
    <script src="../js/config.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/profile.js"></script>
    <script src="../js/friends-service.js"></script>
    <script src="../js/utils.js"></script>
    <!-- Fix script loading issues for moment.js and axios -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.4.0/axios.min.js"></script>
    <script src="../js/gamesquad-ui.js"></script>
</head>
<body>
    <!-- Header Navigation -->
    <header>
        <nav class="navbar">
            <div class="logo">
                <h1 class="sheen">GameSquad</h1>
            </div>
            <ul class="nav-links">
                <li><a href="../home.html">Home</a></li>
                <li><a href="lobbies.html">Lobbies</a></li>
                <li><a href="players.html">Players</a></li>
                <li><a href="about.html">About</a></li>
            </ul>
            <div class="user-profile">
                <span class="username">Username <i class="fas fa-chevron-down"></i></span>
                <div class="profile-dropdown">
                    <a href="profile.html"><i class="fas fa-user"></i> My Profile</a>
                    <a href="messages.html"><i class="fas fa-envelope"></i> Messages</a>
                    <a href="#" class="logout-btn" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a>
                </div>
            </div>
            <div class="hamburger">
                <span class="bar"></span>
                <span class="bar"></span>
                <span class="bar"></span>
            </div>
        </nav>
    </header>

    <main class="container">
        <div class="page-title">
            <h1 class="neon-text">MY PROFILE</h1>
        </div>

        <div class="profile-container fade-element">
            <div class="profile-content fade-stagger">
                <!-- Profile Card Section -->
                <div class="profile-card glow-effect">
                    <div class="profile-image-container">
                        <div class="avatar-wrapper">
                            <img id="profile-avatar" src="../resources/default-avatar.png" alt="Profile Avatar" class="profile-avatar">
                        </div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-display-name">Loading...</h2>
                        <p id="profile-username" class="profile-username">@username</p>
                        <p id="profile-bio" class="profile-bio">Loading bio...</p>
                        <div class="profile-meta">
                            <div class="meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="profile-joined">Joined: Loading...</span>
                            </div>
                            <div class="meta-item">
                                <i class="fas fa-gamepad"></i>
                                <span id="profile-games-played">Games: 0</span>
                            </div>
                        </div>
                        <a href="edit-profile.html" class="btn-primary glow-on-hover" id="edit-profile-btn">
                            <i class="fas fa-edit"></i> Edit Profile
                        </a>
                    </div>
                </div>

                <!-- Game Ranks Section -->
                <div class="profile-section game-ranks-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-medal"></i> GAME RANKS</h3>
                    <div id="game-ranks-container" class="game-ranks-grid">
                        <!-- Game ranks will be added here dynamically -->
                        <div class="empty-state">
                            <i class="fas fa-gamepad"></i>
                            <p>No game ranks added yet</p>
                        </div>
                    </div>
                </div>

                <!-- Preferences Section -->
                <div class="profile-section preferences-section glow-effect">
                    <h3 class="section-title"><i class="fas fa-sliders-h"></i> PREFERENCES</h3>
                    <div class="preferences-grid">
                        <div class="preference-item">
                            <h4>Play Style</h4>
                            <p id="pref-play-style">Casual</p>
                        </div>
                        <div class="preference-item">
                            <h4>Communication</h4>
                            <p id="pref-communication">Both</p>
                        </div>
                        <div class="preference-item">
                            <h4>Play Time</h4>
                            <p id="pref-play-time">Evening</p>
                        </div>
                        <div class="preference-item">
                            <h4>Region</h4>
                            <p id="pref-region">North America</p>
                        </div>
                    </div>
                </div>

                <!-- Languages & Interests Section -->
                <div class="profile-section dual-section glow-effect">
                    <div class="languages-section">
                        <h3 class="section-title"><i class="fas fa-language"></i> LANGUAGES</h3>
                        <div id="languages-container" class="tags-container">
                            <!-- Languages will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-comment-slash"></i>
                                <p>No languages added</p>
                            </div>
                        </div>
                    </div>
                    <div class="interests-section">
                        <h3 class="section-title"><i class="fas fa-heart"></i> INTERESTS</h3>
                        <div id="interests-container" class="tags-container">
                            <!-- Interests will be added here dynamically -->
                            <div class="empty-state">
                                <i class="fas fa-heart-broken"></i>
                                <p>No interests added</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2 class="neon-text">GameSquad</h2>
                    <p>Find your perfect gaming team</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Navigation</h3>
                        <ul>
                            <li><a href="../index.html">Home</a></li>
                            <li><a href="lobbies.html">Lobbies</a></li>
                            <li><a href="players.html">Players</a></li>
                            <li><a href="profile.html">Profile</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Legal</h3>
                        <ul>
                            <li><a href="terms.html">Terms of Service</a></li>
                            <li><a href="privacy.html">Privacy Policy</a></li>
                            <li><a href="cookies.html">Cookie Policy</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Support</h3>
                        <ul>
                            <li><a href="faq.html">FAQ</a></li>
                            <li><a href="contact.html">Contact Us</a></li>
                            <li><a href="report-bug.html">Report a Bug</a></li>
                        </ul>
                    </div>
                </div>
                <div class="footer-social">
                    <h3>Follow Us</h3>
                    <div class="social-icons">
                        <a href="#" class="power-button"><i class="fab fa-discord"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="power-button"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 GameSquad. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Notifications Container -->
    <div class="notifications-container"></div>

    <!-- Main JS -->
    <script src="../js/main.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check if we need to force a complete page reload (if coming from edit page with refresh parameter)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('refresh') && urlParams.get('refresh') === 'true') {
                // Remove the refresh parameter from the URL to prevent infinite reload loops
                const newUrl = window.location.pathname;
                console.log('Force refreshing page to ensure fresh data from server...');
                
                // Remove the query parameters from the URL
                history.replaceState({}, document.title, newUrl);
                
                // Force a HARD reload of the page - this is more aggressive than location.reload(true)
                window.location.href = window.location.href.split('?')[0] + 
                    '?forceRefresh=' + new Date().getTime();
                return;
            }

            // If we have a forceRefresh parameter, we've already reloaded once, so just remove it
            if (urlParams.has('forceRefresh')) {
                // Remove the force refresh parameter
                history.replaceState({}, document.title, window.location.pathname);
            }

            // Initialize animation elements
            const fadeElements = document.querySelectorAll('.fade-element');
            fadeElements.forEach(element => {
                element.classList.add('appear');
            });

            setTimeout(() => {
                const staggerElements = document.querySelectorAll('.fade-stagger');
                staggerElements.forEach(element => {
                    element.classList.add('appear');
                });
            }, 300);

            // Load user profile data
            loadUserProfile();
            
            // Set up tabs if the function exists
            if (typeof window.Profile !== 'undefined' && typeof window.Profile.setupTabs === 'function') {
                window.Profile.setupTabs();
            } else {
                console.log('setupTabs function not available');
            }
        });

        // Load user profile data from database
        async function loadUserProfile() {
            try {
                // Check if user is logged in
                const token = localStorage.getItem('token');
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Show loading state
                showLoadingState();
                
                // Set API URL
                const API_URL = window.APP_CONFIG?.API_URL || '';
                if (!API_URL) {
                    console.error('API URL not defined in APP_CONFIG');
                    throw new Error('API configuration missing');
                }

                // ALWAYS force a direct database fetch, never using cached data
                console.log('Forcing direct database fetch for profile data');
                
                // Always fetch directly from the server with strong anti-caching measures
                try {
                    // Generate unique cache-busting parameters
                    const timestamp = new Date().getTime();
                    const nonce = Math.random().toString(36).substring(2, 15);
                    
                    // First try to fetch from the profiles/me endpoint which might have the complete data
                    console.log(`Fetching profile from database at ${API_URL}/profiles/me with cache busting`);
                    
                    let response;
                    let profileData;
                    
                    try {
                        response = await fetch(`${API_URL}/profiles/me?t=${timestamp}&nonce=${nonce}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            },
                            cache: 'no-store'
                        });
                        
                        // If successful, use this data
                        if (response.ok) {
                            profileData = await response.json();
                            console.log('Fresh profile data fetched from profiles/me endpoint:', profileData);
                        } else {
                            // If failed, fall back to the users/profile endpoint
                            console.log('Could not fetch from profiles/me, falling back to users/profile endpoint');
                            response = await fetch(`${API_URL}/users/profile?t=${timestamp}&nonce=${nonce}`, {
                                method: 'GET',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`,
                                    'Cache-Control': 'no-cache, no-store, must-revalidate',
                                    'Pragma': 'no-cache',
                                    'Expires': '0'
                                },
                                cache: 'no-store'
                            });
                            
                            if (!response.ok) {
                                const errorData = await response.json().catch(() => ({}));
                                console.error('Profile database fetch error:', errorData);
                                throw new Error(errorData.message || `Failed to fetch profile: ${response.status} ${response.statusText}`);
                            }
                            
                            profileData = await response.json();
                            console.log('Fresh profile data fetched from users/profile endpoint:', profileData);
                        }
                    } catch (firstAttemptError) {
                        console.warn('Error with first profile fetch attempt, trying alternate endpoint:', firstAttemptError);
                        
                        // Try the alternate endpoint if the first one fails
                        response = await fetch(`${API_URL}/users/profile?t=${timestamp}&nonce=${nonce}`, {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`,
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache',
                                'Expires': '0'
                            },
                            cache: 'no-store'
                        });
                        
                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({}));
                            console.error('Profile database fetch error:', errorData);
                            throw new Error(errorData.message || `Failed to fetch profile: ${response.status} ${response.statusText}`);
                        }
                        
                        profileData = await response.json();
                        console.log('Fresh profile data fetched from alternate endpoint:', profileData);
                    }
                    
                    // Remove any stored profile data from localStorage to prevent stale data
                    try {
                        const userInfoStr = localStorage.getItem('userInfo');
                        if (userInfoStr) {
                            const userInfo = JSON.parse(userInfoStr);
                            delete userInfo.profile;
                            localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        }
                    } catch (e) {
                        console.warn('Error clearing profile cache:', e);
                    }
                    
                    // Update UI with fresh database data
                    updateProfileUI(profileData);
                    return;
                } catch (fetchError) {
                    console.error('Error fetching fresh profile data from database:', fetchError);
                    throw new Error('Could not fetch profile from database: ' + fetchError.message);
                }
            } catch (error) {
                console.error('Error loading profile:', error);
                showNotification('Failed to load profile: ' + error.message, 'error');
            }
        }
        
        // Show loading state in UI
        function showLoadingState() {
            // Set loading indicators for each section
            document.getElementById('profile-display-name').textContent = 'Loading...';
            document.getElementById('profile-username').textContent = '@loading';
            document.getElementById('profile-bio').textContent = 'Loading bio...';
        }
        
        // Update UI with profile data
        function updateProfileUI(profile) {
            console.log('Updating UI with profile data (full object):', JSON.stringify(profile, null, 2));
            
            // Make sure profile is an object
            if (!profile || typeof profile !== 'object') {
                console.error('Invalid profile data received:', profile);
                showNotification('Error: Invalid profile data received from server', 'error');
                return;
            }

            // Log specific parts of the profile to understand structure
            console.log('displayName:', profile.displayName);
            console.log('bio:', profile.bio);
            console.log('gameRanks:', profile.gameRanks);
            console.log('languages:', profile.languages);
            console.log('interests:', profile.interests);
            console.log('preferences:', profile.preferences);

            // Basic user info - handle different possible data structures
            let displayName = '';
            let username = '';
            
            // Try to extract displayName and username from different possible structures
            if (profile.displayName) {
                displayName = profile.displayName;
            } else if (profile.user && profile.user.username) {
                displayName = profile.user.username;
            } else if (profile.username) {
                displayName = profile.username;
            } else {
                displayName = 'User';
            }
            
            // Extract username
            if (profile.user && profile.user.username) {
                username = profile.user.username;
            } else if (profile.username) {
                username = profile.username;
            } else if (profile.email) {
                username = profile.email;
            }
            
            // Update display name and username in UI
            document.getElementById('profile-display-name').textContent = displayName;
            document.getElementById('profile-username').textContent = username ? `@${username}` : '';
            
            // Profile image
            const avatarEl = document.getElementById('profile-avatar');
            if (avatarEl) {
                const avatarUrl = profile.avatar || '../resources/default-avatar.png';
                if (avatarUrl && !avatarUrl.startsWith('http')) {
                    avatarEl.src = `../${avatarUrl.startsWith('/') ? avatarUrl.substring(1) : avatarUrl}`;
                } else {
                    avatarEl.src = avatarUrl || '../resources/default-avatar.png';
                }
            }
            
            // Bio - ensure we're getting the actual bio from the database
            const bioEl = document.getElementById('profile-bio');
            if (bioEl) {
                bioEl.textContent = profile.bio || 'No bio provided';
            }
            
            // Join date - try different date fields
            const joinedEl = document.getElementById('profile-joined');
            if (joinedEl) {
                let dateString = 'Unknown date';
                if (profile.createdAt) {
                    const date = new Date(profile.createdAt);
                    dateString = `Joined: ${date.toLocaleDateString()}`;
                } else if (profile.user && profile.user.createdAt) {
                    const date = new Date(profile.user.createdAt);
                    dateString = `Joined: ${date.toLocaleDateString()}`;
                }
                joinedEl.textContent = dateString;
            }
            
            // Games played count for the profile card
            const gamesPlayedEl = document.getElementById('profile-games-played');
            if (gamesPlayedEl) {
                const gamesPlayed = profile.gamesPlayed || 0;
                gamesPlayedEl.textContent = `Games: ${gamesPlayed}`;
            }
            
            // Game ranks - handle all possible structures
            const gameRanksContainer = document.getElementById('game-ranks-container');
            if (gameRanksContainer) {
                // Try to get game ranks from the profile
                let gameRanks = [];
                
                // First try gameRanks as an array
                if (Array.isArray(profile.gameRanks)) {
                    gameRanks = profile.gameRanks;
                    console.log('GameRanks found as an array:', gameRanks);
                } 
                // Then try gameRanks as an object (MongoDB sometimes returns this way)
                else if (profile.gameRanks && typeof profile.gameRanks === 'object') {
                    // Extract values from the gameRanks object
                    gameRanks = Object.values(profile.gameRanks);
                    console.log('GameRanks found as an object, converted to array:', gameRanks);
                }
                
                if (gameRanks.length > 0) {
                    gameRanksContainer.innerHTML = ''; // Clear the container
                    
                    // Create game rank cards
                    gameRanks.forEach(gameRank => {
                        console.log('Processing gameRank item:', gameRank);
                        
                        // Try to extract game name and rank from different possible structures
                        let gameName, rankValue;
                        
                        if (typeof gameRank === 'object' && gameRank !== null) {
                            // Try standard format
                            if (gameRank.game !== undefined) {
                                gameName = gameRank.game;
                                rankValue = gameRank.rank;
                            } 
                            // Try alternate format
                            else if (gameRank.name !== undefined) {
                                gameName = gameRank.name;
                                rankValue = gameRank.value || gameRank.level || gameRank.rank;
                            }
                            // If the object only has one key, assume it's the game name
                            else if (Object.keys(gameRank).length === 1) {
                                const key = Object.keys(gameRank)[0];
                                gameName = key;
                                rankValue = gameRank[key];
                            }
                        } else if (typeof gameRank === 'string') {
                            // If it's just a string, use that as the game name
                            gameName = gameRank;
                            rankValue = 'Unranked';
                        }
                        
                        // Only add if we have a game name
                        if (gameName) {
                            const gameRankCard = document.createElement('div');
                            gameRankCard.className = 'game-rank-card';
                            gameRankCard.innerHTML = `
                                <h4>${gameName}</h4>
                                <div class="rank-badge">${rankValue || 'Unranked'}</div>
                            `;
                            gameRanksContainer.appendChild(gameRankCard);
                        }
                    });
                } else {
                    // Show empty state
                    gameRanksContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-gamepad"></i>
                            <p>No game ranks added yet</p>
                        </div>
                    `;
                }
            }
            
            // Preferences - directly use the preferences object from the profile
            const preferences = profile.preferences || {};
            
            // Play Style
            const prefPlayStyleEl = document.getElementById('pref-play-style');
            if (prefPlayStyleEl) {
                prefPlayStyleEl.textContent = preferences.playStyle || 'Casual';
            }
            
            // Communication
            const prefCommunicationEl = document.getElementById('pref-communication');
            if (prefCommunicationEl) {
                prefCommunicationEl.textContent = preferences.communication || 'Both';
            }
            
            // Play Time
            const prefPlayTimeEl = document.getElementById('pref-play-time');
            if (prefPlayTimeEl) {
                prefPlayTimeEl.textContent = preferences.playTime || 'Evening';
            }
            
            // Region
            const prefRegionEl = document.getElementById('pref-region');
            if (prefRegionEl) {
                prefRegionEl.textContent = preferences.region || 'North America';
            }
            
            // Languages - directly use the languages array from the profile
            const languagesContainer = document.getElementById('languages-container');
            if (languagesContainer) {
                // Try to get languages from the profile
                let languages = [];
                
                // First try languages as an array
                if (Array.isArray(profile.languages)) {
                    languages = profile.languages;
                    console.log('Languages found as an array:', languages);
                } 
                // Then try languages as an object (MongoDB sometimes returns this way)
                else if (profile.languages && typeof profile.languages === 'object') {
                    // Extract values from the languages object
                    languages = Object.values(profile.languages);
                    console.log('Languages found as an object, converted to array:', languages);
                }
                
                if (languages.length > 0) {
                    languagesContainer.innerHTML = '';
                    
                    languages.forEach(language => {
                        if (language) {
                            const tag = document.createElement('span');
                            tag.className = 'tag';
                            tag.textContent = language;
                            languagesContainer.appendChild(tag);
                        }
                    });
                } else {
                    // Show empty state
                    languagesContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-comment-slash"></i>
                            <p>No languages added</p>
                        </div>
                    `;
                }
            }
            
            // Interests - directly use the interests array from the profile
            const interestsContainer = document.getElementById('interests-container');
            if (interestsContainer) {
                // Try to get interests from the profile
                let interests = [];
                
                // First try interests as an array
                if (Array.isArray(profile.interests)) {
                    interests = profile.interests;
                    console.log('Interests found as an array:', interests);
                } 
                // Then try interests as an object (MongoDB sometimes returns this way)
                else if (profile.interests && typeof profile.interests === 'object') {
                    // Extract values from the interests object
                    interests = Object.values(profile.interests);
                    console.log('Interests found as an object, converted to array:', interests);
                }
                
                if (interests.length > 0) {
                    interestsContainer.innerHTML = '';
                    
                    interests.forEach(interest => {
                        if (interest) {
                            const tag = document.createElement('span');
                            tag.className = 'tag';
                            tag.textContent = interest;
                            interestsContainer.appendChild(tag);
                        }
                    });
                } else {
                    // Show empty state
                    interestsContainer.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-heart-broken"></i>
                            <p>No interests added</p>
                        </div>
                    `;
                }
            }
            
            // Show a success notification that data was loaded from database
            showNotification('Profile data loaded fresh from database', 'success');
        }
        
        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            
            // Add to notifications container
            const container = document.querySelector('.notifications-container');
            container.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html> 